# logLLM CLI: `normalize-ts` Command

The `normalize-ts` command interfaces with the `TimestampNormalizerAgent` to process parsed log data stored in Elasticsearch (`parsed_log_<group_name>` indices). It offers two main actions: standardizing timestamp information or removing the standardized timestamp field.

**Prerequisites:**

- Elasticsearch must be running (`python -m src.logllm db start`).
- Parsed logs must exist in `parsed_log_<group_name>` indices, typically generated by `static-grok-parse run ...`.

**Base command:** `python -m src.logllm normalize-ts <action> [OPTIONS]`

See also: [Global Options](./global_options.md)

---

## Actions

### `normalize-ts run`

Executes the timestamp normalization process. For each selected group, it:

1.  Scans documents in the `parsed_log_<group_name>` index.
2.  Attempts to find and parse various timestamp formats from a field (default: "timestamp").
3.  Converts the parsed timestamp to UTC ISO 8601 format.
4.  Updates the document in-place by adding or overwriting the `@timestamp` field with the normalized value.

**Usage:**

```bash
python -m src.logllm normalize-ts run [OPTIONS]
```

**Options (Group Selection - Mutually Exclusive, Required):**

- `-g GROUP`, `--group GROUP`:
  Specify a single group name (e.g., "apache") whose `parsed_log_<group_name>` index should be processed.
- `-a`, `--all-groups`:
  Process all groups found in the Elasticsearch `group_infos` index. The system will iterate through each group and normalize its corresponding `parsed_log_<group_name>` index.

**Common Options for `run`:**

- `-l LIMIT`, `--limit LIMIT`:
  (Optional, primarily for testing) Limits the number of documents processed _per group_.
- `-b BATCH_SIZE`, `--batch-size BATCH_SIZE`:
  The number of documents to process and update in each bulk ES request.
  Defaults to `DEFAULT_BATCH_SIZE_NORMALIZER` (e.g., 5000).

**Examples:**

1.  **Normalize timestamps for the "apache" group, processing only the first 50 documents for testing:**

    ```bash
    python -m src.logllm normalize-ts run -g apache -l 50
    ```

    This will read from and update documents in `parsed_log_apache`.

2.  **Normalize timestamps for ALL known log groups:**
    ```bash
    python -m src.logllm normalize-ts run -a
    ```

---

### `normalize-ts delete`

Removes the `@timestamp` field from documents within the `parsed_log_<group_name>` indices. This effectively undoes the "normalize" action for the `@timestamp` field.

**Usage:**

```bash
python -m src.logllm normalize-ts delete [OPTIONS]
```

**Options (Group Selection - Mutually Exclusive, Required):**

- `-g GROUP`, `--group GROUP`:
  Specify a single group name. The command will attempt to remove the `@timestamp` field from documents in the `parsed_log_<group_name>` index.
- `-a`, `--all-groups`:
  Attempt to remove the `@timestamp` field from `parsed_log_<group_name>` indices for all groups found in `group_infos`.

**Common Options for `delete`:**

- `-b BATCH_SIZE`, `--batch-size BATCH_SIZE`:
  The number of documents to process in each bulk ES request for field removal.
  Defaults to `DEFAULT_BATCH_SIZE_NORMALIZER` (e.g., 5000).
- `-y`, `--yes`:
  If specified, the command will proceed with the field removal without prompting the user for confirmation. **Use this option with caution.**

**Examples:**

1.  **Delete the `@timestamp` field for the "hadoop" group, with confirmation:**

    ```bash
    python -m src.logllm normalize-ts delete -g hadoop
    ```

    Output: `Are you sure you want to remove the '@timestamp' field... (yes/no):`
    Enter `yes` to proceed.

2.  **Delete the `@timestamp` field for ALL groups, skipping confirmation:**
    ```bash
    python -m src.logllm normalize-ts delete -a -y
    ```

**Output (for both `run` and `delete`):**
The CLI will print a summary of the agent's run, including overall status, any errors, and for each processed group: status, documents scanned, documents updated, and normalization errors (if applicable).
