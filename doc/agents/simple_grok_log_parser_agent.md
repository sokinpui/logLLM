# Simple Grok Log Parser Agent (`parser_agent.py`)

## File: `src/logllm/agents/parser_agent.py`

### Overview

This document describes the `SimpleGrokLogParserAgent` and its related data structures, which are focused on parsing log files directly from the local filesystem using Grok.

### Class: `SimpleGrokLogParserState(TypedDict)`

- **Purpose**: Defines the data structure (state) passed between steps and returned by the `SimpleGrokLogParserAgent`.
- **Fields**:
  - `log_file_path` (str): The absolute path to the log file being processed.
  - `grok_pattern` (Optional[str]): The Grok pattern string used for parsing. This can be provided initially or generated by the agent.
  - `output_csv_path` (str): The path where the resulting CSV file is saved. Empty if parsing fails or produces no output.
  - `sample_logs` (str): A string containing sample log lines extracted from the file, used as context if the LLM needs to generate a pattern. Populated by the agent.
  - `parsed_lines` (int): A counter for the number of log lines successfully matched and parsed by the Grok pattern.
  - `skipped_lines` (int): A counter for the number of log lines that did _not_ match the Grok pattern.

### Class: `GrokPatternSchema(BaseModel)`

- **Purpose**: A Pydantic data model defining the expected structure for the LLM's response when asked to generate a Grok pattern. This ensures the LLM returns only the pattern string.
- **Fields**:
  - `grok_pattern` (str): The generated Grok pattern string.

### Class: `SimpleGrokLogParserAgent`

- **Purpose**: An agent designed to parse a _single_ log file using a Grok pattern. It can either use a user-provided pattern or generate one using an LLM if none is supplied. The output is a CSV file containing the parsed fields.
- **Key Methods**:
  - **`__init__(self, model: LLMModel)`**
    - **Description**: Initializes the agent. Requires an instance of an `LLMModel` (like `GeminiModel`) for pattern generation and initializes a `PromptsManager` to fetch the necessary prompts.
    - **Parameters**:
      - `model` (LLMModel): The language model instance.
    - **Usage**: `agent = SimpleGrokLogParserAgent(model=my_llm_model)`
  - **`run(self, initial_state: SimpleGrokLogParserState, show_progress: bool = False) -> SimpleGrokLogParserState`**
    - **Description**: The main entry point for parsing a single file. It takes the initial state (requiring `log_file_path`), checks if a `grok_pattern` is present, calls `_generate_grok_pattern` if needed, then calls `_run_grok_parser` to perform the actual parsing and CSV writing.
    - **Parameters**:
      - `initial_state` (SimpleGrokLogParserState): The starting state, must include `log_file_path`, optionally `grok_pattern`.
      - `show_progress` (bool): Flag primarily for compatibility with the group parser; has minimal direct effect on this agent's output.
    - **Returns**: (SimpleGrokLogParserState): The final state containing the `output_csv_path` (if successful), `parsed_lines`, `skipped_lines`, and the `grok_pattern` used.
    - **Usage**: `result = agent.run({"log_file_path": "logs/ssh/SSH.log"})`
  - **`_generate_grok_pattern(self, log_file_path: str) -> Optional[str]`**
    - **Description**: An internal method responsible for generating a Grok pattern using the configured LLM. It reads sample lines from the provided log file, fetches the appropriate prompt using `PromptsManager`, calls the LLM with the samples and the `GrokPatternSchema`, and returns the validated pattern string.
    - **Parameters**:
      - `log_file_path` (str): The path to the log file to sample for context.
    - **Returns**: (Optional[str]): The generated Grok pattern string, or `None` if sampling, LLM call, or validation fails.
    - **Usage**: Called automatically by `run` if `initial_state["grok_pattern"]` is `None`.
  - **`_run_grok_parser(self, state: SimpleGrokLogParserState) -> SimpleGrokLogParserState`**
    - **Description**: An internal method that performs the core Grok parsing. It takes the state (which must now include a valid `grok_pattern`), compiles the pattern using `pygrok.Grok`, reads the input log file line by line, attempts to match each line against the pattern, collects the parsed dictionaries, dynamically determines all unique field names (headers) from the matches, and writes the results to a CSV file named `parsed_grok_<original_basename>.csv` in the same directory as the input file. Updates `parsed_lines` and `skipped_lines` in the state.
    - **Parameters**:
      - `state` (SimpleGrokLogParserState): The state containing `log_file_path` and a valid `grok_pattern`.
    - **Returns**: (SimpleGrokLogParserState): The updated state with `output_csv_path` set upon successful CSV writing, and updated `parsed_lines`/`skipped_lines` counts.
    - **Usage**: Called by `run` after a valid Grok pattern is available.
